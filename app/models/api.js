var STATIC_SUBSCRIPTIONS = {
    "subscriptions": [{
        "id": "feed/http://community.washingtonpost.com/ver1.0/Blog/BlogRss?plckBlogId\u003dBlog:a6548fc3-7387-4b45-b0f7-cd436dacd5e0",
        "title": "Admissions 101",
        "categories": [{
            "id": "user/05264062175026038092/label/News",
            "label": "News"
        }],
        "sortid": "A88635A0",
        "firstitemmsec": "1262278653165",
        "htmlUrl": "http://www.washingtonpost.com/wp-srv/community/groups/announcement.html?wpBlogId\u003dBlog:a6548fc3-7387-4b45-b0f7-cd436dacd5e0\u0026plckBlogPage\u003dBlog"
    },
    {
        "id": "feed/http://moneywatch.bnet.com/investing/blog/against-grain/feed/rss/",
        "title": "Against the Grain Blog RSS | MoneyWatch",
        "categories": [{
            "id": "user/05264062175026038092/label/Business",
            "label": "Business"
        }],
        "sortid": "DA4A2D30",
        "firstitemmsec": "1250211584852",
        "htmlUrl": "http://moneywatch.bnet.com/investing/blog/against-grain/feed/rss/"
    },
    {
        "id": "feed/http://feeds.feedburner.com/baltimoresun/sports/baseball/rss2",
        "title": "baltimoresun.com - Orioles",
        "categories": [{
            "id": "user/05264062175026038092/label/Sports",
            "label": "Sports"
        }],
        "sortid": "23D6A75B",
        "firstitemmsec": "1214922584311",
        "htmlUrl": "http://www.baltimoresun.com/sports/orioles/?track\u003drss"
    },
    {
        "id": "feed/http://pivotallabs.com/users/chris/blog.rss",
        "title": "Christian Sepulveda",
        "categories": [{
            "id": "user/05264062175026038092/label/Tech",
            "label": "Tech"
        }],
        "sortid": "8ADD0C2F",
        "firstitemmsec": "1246743096604"
    },
    {
        "id": "feed/http://voices.washingtonpost.com/college-inc/atom.xml",
        "title": "College Inc.",
        "categories": [{
            "id": "user/05264062175026038092/label/News",
            "label": "News"
        }],
        "sortid": "9CABBB34",
        "firstitemmsec": "1269513913729",
        "htmlUrl": "http://voices.washingtonpost.com/college-inc/"
    },
    {
        "id": "feed/http://www.engadgetmobile.com/bloggers/joshua-topolsky/rss.xml",
        "title": "Engadget Mobile",
        "categories": [{
            "id": "user/05264062175026038092/label/Tech",
            "label": "Tech"
        }],
        "sortid": "728C7658",
        "firstitemmsec": "1249571888472",
        "htmlUrl": "http://www.engadgetmobile.com"
    },
    {
        "id": "feed/http://feeds2.feedburner.com/ExploreBonds",
        "title": "Explore Bonds",
        "categories": [{
            "id": "user/05264062175026038092/label/Business",
            "label": "Business"
        }],
        "sortid": "BF519A8D",
        "firstitemmsec": "1240181703894",
        "htmlUrl": "http://explorebonds.com/"
    },
    {
        "id": "feed/http://www.arcamax.com/familyfilms/channelfeed",
        "title": "Family Filmgoer",
        "categories": [{
            "id": "user/05264062175026038092/label/Style",
            "label": "Style"
        }],
        "sortid": "85DA6773",
        "firstitemmsec": "1214922584313",
        "htmlUrl": "http://www.arcamax.com/familyfilms"
    },
    {
        "id": "feed/http://status.fastmail.fm/feed/",
        "title": "FastMail.FM Status",
        "categories": [{
            "id": "user/05264062175026038092/label/Tech",
            "label": "Tech"
        }],
        "sortid": "5A22E867",
        "firstitemmsec": "1218115972280",
        "htmlUrl": "http://status.fastmail.fm"
    },
    {
        "id": "feed/http://feeds.feedburner.com/fastmailblog",
        "title": "FastMail.FM Weblog",
        "categories": [{
            "id": "user/05264062175026038092/label/Tech",
            "label": "Tech"
        }],
        "sortid": "F63DB9D5",
        "firstitemmsec": "1214302488373",
        "htmlUrl": "http://blog.fastmail.fm"
    },
    {
        "id": "feed/http://googlereader.blogspot.com/feeds/posts/default",
        "title": "Google Reader",
        "categories": [{
            "id": "user/05264062175026038092/label/Tech",
            "label": "Tech"
        }],
        "sortid": "E9204804",
        "firstitemmsec": "1210272538845",
        "htmlUrl": "http://googlereader.blogspot.com/"
    },
    {
        "id": "feed/http://googlevoiceblog.blogspot.com/atom.xml",
        "title": "Google Voice Blog",
        "categories": [{
            "id": "user/05264062175026038092/label/Tech",
            "label": "Tech"
        }],
        "sortid": "D3FBF50D",
        "firstitemmsec": "1236838931580",
        "htmlUrl": "http://googlevoiceblog.blogspot.com/"
    },
    {
        "id": "feed/http://www.indextown.com/feed/",
        "title": "indexfundfan @ indextown",
        "categories": [{
            "id": "user/05264062175026038092/label/Business",
            "label": "Business"

        }],
        "sortid": "00DBCD36",
        "firstitemmsec": "1248458421622",
        "htmlUrl": "http://www.indextown.com"
    },
    {
        "id": "feed/http://insidesprintnow.wordpress.com/feed/",
        "title": "Inside Sprint Now",
        "categories": [{
            "id": "user/05264062175026038092/label/Tech",
            "label": "Tech"
        }],
        "sortid": "402C6787",
        "firstitemmsec": "1236062194573",
        "htmlUrl": "http://insidesprintnow.wordpress.com"
    },
    {
        "id": "feed/http://www.washingtonpost.com/wp-dyn/rss/linkset/2005/03/25/LI2005032502360.xml",
        "title": "Lisa de Moraes",
        "categories": [{
            "id": "user/05264062175026038092/label/Style",
            "label": "Style"
        }],
        "sortid": "31295522",
        "firstitemmsec": "1219686710497",
        "htmlUrl": "http://www.washingtonpost.com?nav\u003drss_opinion/columns"
    },
    {
        "id": "feed/http://moneywatch.bnet.com/investing/blog/make-money/feed/rss/?tag\u003dcol1;drawer",
        "title": "Make the Most of Your Money Blog RSS | MoneyWatch",
        "categories": [{
            "id": "user/05264062175026038092/label/Business",
            "label": "Business"
        }],
        "sortid": "F6909354",
        "firstitemmsec": "1280146581629",
        "htmlUrl": "http://moneywatch.bnet.com/investing/blog/make-money/feed/rss/"

    },
    {
        "id": "feed/http://moneywatch.bnet.com/investing/blog/fund-watch/feed/rss/?tag\u003dcol1;drawer",
        "title": "Mutual Fund Insider Blog RSS | MoneyWatch",
        "categories": [{
            "id": "user/05264062175026038092/label/Business",
            "label": "Business"
        }],
        "sortid": "C5125FAD",
        "firstitemmsec": "1248743025013",
        "htmlUrl": "http://moneywatch.bnet.com/investing/blog/fund-watch/feed/rss/"
    },
    {
        "id": "feed/http://www.nytimes.com/services/xml/rss/nyt/HomePage.xml",
        "title": "NYT \u003e Home Page",
        "categories": [{
            "id": "user/05264062175026038092/label/News",
            "label": "News"
        }],
        "sortid": "B052F118",
        "firstitemmsec": "1231827989294",
        "htmlUrl": "http://www.nytimes.com/pages/index.html?partner\u003drss\u0026emc\u003drss"
    },
    {
        "id": "feed/http://topics.nytimes.com/your-money/investments/?rss\u003d1",
        "title": "NYT \u003e Investments",
        "categories": [{
            "id": "user/05264062175026038092/label/Business",
            "label": "Business"
        }],
        "sortid": "0CC9E49B",
        "firstitemmsec": "1265574107541"
    },
    {
        "id": "feed/http://www.politico.com/rss/playbook.xml",
        "title": "POLITICO - Top 10 - Playbook 24/7",
        "categories": [
        {
            "id": "user/05264062175026038092/label/Politics",
            "label": "Politics"
        }],
        "sortid": "BB42CC54",
        "firstitemmsec": "1271072527973",
        "htmlUrl": "http://www.politico.com/playbook"
    },
    {
        "id": "feed/http://blogs.brown.edu/admissions/feed/",
        "title": "Prospects \u0026 Providence",
        "categories": [],
        "sortid": "BE790AA7",
        "firstitemmsec": "1279572838021",
        "htmlUrl": "http://blogs.brown.edu/admissions"
    },
    {
        "id": "feed/http://redsoxrantsfromchina.blogspot.com/feeds/posts/default?alt\u003drss",
        "title": "Red Sox Rants from China",
        "categories": [
        {
            "id": "user/05264062175026038092/label/Sports",
            "label": "Sports"
        }],
        "sortid": "0CFFA317",
        "firstitemmsec": "1214922584314",
        "htmlUrl": "http://redsoxrantsfromchina.blogspot.com/"
    },
    {
        "id": "feed/http://masnsports.com/school_of_roch/atom.xml",
        "title": "School of Roch",
        "categories": [{
            "id": "user/05264062175026038092/label/Sports",
            "label": "Sports"
        }],
        "sortid": "99414A17",
        "firstitemmsec": "1271101763526",
        "htmlUrl": "http://www.masnsports.com/school_of_roch/"
    },
    {
        "id": "feed/http://thechoice.blogs.nytimes.com/feed/",
        "title": "The Choice",
        "categories": [{
            "id": "user/05264062175026038092/label/News",
            "label": "News"
        }],
        "sortid": "4E8EE744",
        "firstitemmsec": "1251469825542",
        "htmlUrl": "http://thechoice.blogs.nytimes.com/"
    },
    {
        "id": "feed/http://blog.dropbox.com/?feed\u003drss2",
        "title": "The Dropbox Blog",
        "categories": [{
            "id": "user/05264062175026038092/label/Tech",
            "label": "Tech"
        }],
        "sortid": "A63BBAF5",
        "firstitemmsec": "1261602445499",
        "htmlUrl": "http://blog.dropbox.com"
    },
    {
        "id": "feed/http://moneywatch.bnet.com/investing/blog/irrational-investor/feed/rss/?tag\u003dcol1;drawer",
        "title": "The Irrational Investor Blog RSS | MoneyWatch",
        "categories": [{
            "id": "user/05264062175026038092/label/Business",
            "label": "Business"
        }],
        "sortid": "6C1BA562",
        "firstitemmsec": "1250878272031",
        "htmlUrl": "http://moneywatch.bnet.com/investing/blog/irrational-investor/feed/rss/"
    },
    {
        "id": "feed/http://sessionbeerproject.blogspot.com/feeds/posts/default",
        "title": "The Session Beer Project™",
        "categories": [{
            "id": "user/05264062175026038092/label/Style",
            "label": "Style"
        }],
        "sortid": "FFB8F9D2",
        "firstitemmsec": "1236263640267",
        "htmlUrl": "http://sessionbeerproject.blogspot.com/"
    },
    {
        "id": "feed/http://www.washingtonpost.com/wp-dyn/rss/linkset/2005/03/24/LI2005032402771.xml",
        "title": "Tom Shales",
        "categories": [{
            "id": "user/05264062175026038092/label/Style",
            "label": "Style"
        }],
        "sortid": "E017FF30",
        "firstitemmsec": "1219074263327",
        "htmlUrl": "http://www.washingtonpost.com?nav\u003drss_opinion/columns"
    },
    {
        "id": "feed/http://feedproxy.google.com/wp-dyn/rss/linkset/2005/03/25/LI2005032502493_xml",
        "title": "Tom Sietsema",
        "categories": [{
            "id": "user/05264062175026038092/label/Style",
            "label": "Style"
        }],
        "sortid": "3BA9A685",
        "firstitemmsec": "1220957255886",
        "htmlUrl": "http://www.washingtonpost.com?nav\u003drss_artsandliving/foodanddining"
    },
    {
        "id": "feed/http://walt.allthingsd.com/feed/",
        "title": "Walt Mossberg",
        "categories": [{
            "id": "user/05264062175026038092/label/Tech",
            "label": "Tech"
        }],
        "sortid": "3027F485",
        "firstitemmsec": "1245282155186",
        "htmlUrl": "http://walt.allthingsd.com"
    },
    {
        "id": "feed/http://feeds.washingtonpost.com/wp-dyn/rss/linkset/2005/03/24/LI2005032402520_xml",
        "title": "washingtonpost.com - Thomas Boswell (washingtonpost.com)",
        "categories": [{
            "id": "user/05264062175026038092/label/Sports",
            "label": "Sports"
        }],
        "sortid": "58189AA5",
        "firstitemmsec": "1241585462862",
        "htmlUrl": "http://www.washingtonpost.com?nav\u003drss_opinion/columns"
    },
    {
        "id": "feed/http://moneywatch.bnet.com/investing/blog/wise-investing/feed/rss/?tag\u003dcol1;drawer",
        "title": "Wise Investing Blog RSS | MoneyWatch",
        "categories": [{
            "id": "user/05264062175026038092/label/Business",
            "label": "Business"
        }],
        "sortid": "EAA36F4E",
        "firstitemmsec": "1252345121542",
        "htmlUrl": "http://moneywatch.bnet.com/investing/blog/wise-investing/feed/rss/"

    },
    {
        "id": "feed/http://www.washingtonpost.com/wp-dyn/rss/business/index.xml",
        "title": "WP Business",
        "categories": [{
            "id": "user/05264062175026038092/label/Business",
            "label": "Business"
        }],
        "sortid": "F88E8583",
        "firstitemmsec": "1214922584327",
        "htmlUrl": "http://www.washingtonpost.com/wp-dyn/content/business/index.html?wprss\u003drss_business"
    },
    {
        "id": "feed/http://www.washingtonpost.com/wp-dyn/rss/print/metro/index.xml",
        "title": "WP Metro",
        "categories": [{
            "id": "user/05264062175026038092/label/News",
            "label": "News"

        }],
        "sortid": "D12480AD",
        "firstitemmsec": "1214922584338",
        "htmlUrl": "http://www.washingtonpost.com/wp-dyn/content/print/metro/index.html?wprss\u003drss_print/metro"
    },
    {
        "id": "feed/http://www.washingtonpost.com/wp-dyn/rss/linkset/2005/03/24/LI2005032400102.xml",
        "title": "WP Today's Highlights",
        "categories": [{
            "id": "user/05264062175026038092/label/Business",
            "label": "Business"
        }],
        "sortid": "0ED604EC",
        "firstitemmsec": "1214922584346",
        "htmlUrl": "http://www.washingtonpost.com/?nav\u003drss_email/components"
    }]
}

var STATIC_UNREAD_COUNTS =  {
    "max": 1000,
    "unreadcounts": [{
        "id": "user/05264062175026038092/state/com.google/reading-list",
        "count": 5,
        "newestItemTimestampUsec": "1286648862217358"

    },
    {
        "id": "user/05264062175026038092/label/News",
        "count": 3,
        "newestItemTimestampUsec": "1286643848450928"

    },
    {
        "id": "user/05264062175026038092/label/Business",
        "count": 2,
        "newestItemTimestampUsec": "1286648862217358"

    },
    {
        "id": "feed/http://www.nytimes.com/services/xml/rss/nyt/HomePage.xml",
        "count": 3,
        "newestItemTimestampUsec": "1286643848450928"

    },
    {
        "id": "feed/http://www.washingtonpost.com/wp-dyn/rss/linkset/2005/03/24/LI2005032400102.xml",
        "count": 2,
        "newestItemTimestampUsec": "1286648862217358"

    }]

}

var Api = Class.create({
  login: function(credentials, success, failure) {
    var authSuccess = function(response) {
      var authMatch = response.responseText.match(/Auth\=(.*)/)
      this.auth = authMatch ? authMatch[1] : ''
      success(this.auth)
    }.bind(this)

    new Ajax.Request("https://www.google.com/accounts/ClientLogin", {
      method: "get",
      parameters: {service: "reader", Email: credentials.email, Passwd: credentials.password},
      onSuccess: authSuccess,
      onFailure: failure
    })
  },

  getAllSubscriptions: function(success, failure) {
    // success(STATIC_SUBSCRIPTIONS.subscriptions)
    new Ajax.Request(Api.BASE_URL + "subscription/list", {
      method: "get",
      parameters: {output: "json"},
      requestHeaders: this._requestHeaders(),
      onFailure: failure,
      onSuccess: function(response) {success(response.responseText.evalJSON().subscriptions)}
    })
  },

  getUnreadCounts: function(success, failure) {
    // success(STATIC_UNREAD_COUNTS.unreadcounts)
    new Ajax.Request(Api.BASE_URL + "unread-count", {
      method: "get",
      parameters: {output: "json"},
      requestHeaders: this._requestHeaders(),
      onFailure: failure,
      onSuccess: function(response) {success(response.responseText.evalJSON().unreadcounts)}
    })
  },

  getAllArticles: function(continuation, success, failure) {
    this._getArticles(
      "user/-/state/com.google/reading-list",
      Preferences.hideReadArticles() ? "user/-/state/com.google/read" : null,
      continuation,
      success,
      failure
    )
  },

  getAllStarred: function(continuation, success, failure) {
    this._getArticles(
      "user/-/state/com.google/starred",
      null,
      continuation,
      success,
      failure
    )
  },

  getAllArticlesFor: function(id, continuation, success, failure) {
    this._getArticles(
      id,
      Preferences.hideReadArticles() ? "user/-/state/com.google/read" : null,
      continuation,
      success,
      failure
    )
  },

  _getArticles: function(id, exclude, continuation, success, failure) {
    var parameters = {output: "json", n: 30}

    if(Preferences.isOldestFirst()) {
      parameters.r = "o"
    }

    if(continuation) {
      parameters.c = continuation
    }

    if(exclude) {
      parameters.xt = exclude
    }

    new Ajax.Request(Api.BASE_URL + "stream/contents/" + escape(id), {
      method: "get",
      parameters: parameters,
      requestHeaders: this._requestHeaders(),
      onFailure: failure,
      onSuccess: function(response) {
        var articles = response.responseText.evalJSON()
        success(articles.items, articles.id, articles.continuation)
      }
    })
  },

  markAllRead: function(id, success) {
    this._getEditToken(function(token) {
      var parameters = {
        T: token,
        s: id
      }

      new Ajax.Request(Api.BASE_URL + "mark-all-as-read", {
        method: "post",
        parameters: parameters,
        requestHeaders: this._requestHeaders(),
        onSuccess: success
      })
    }.bind(this))
  },

  setArticleRead: function(articleId, subscriptionId, success) {
    this._editTag(
      articleId,
      subscriptionId,
      "user/-/state/com.google/read",
      null,
      success
    )
  },

  setArticleNotRead: function(articleId, subscriptionId, success) {
    this._editTag(
      articleId,
      subscriptionId,
      "user/-/state/com.google/kept-unread",
      "user/-/state/com.google/read",
      success
    )
  },

  setArticleShared: function(articleId, subscriptionId, success) {
    this._editTag(
      articleId,
      subscriptionId,
      "user/-/state/com.google/broadcast",
      null,
      success
    )
  },

  setArticleNotShared: function(articleId, subscriptionId, success) {
    this._editTag(
      articleId,
      subscriptionId,
      null,
      "user/-/state/com.google/broadcast",
      success
    )
  },

  setArticleStarred: function(articleId, subscriptionId, success) {
    this._editTag(
      articleId,
      subscriptionId,
      "user/-/state/com.google/starred",
      null,
      success
    )
  },

  setArticleNotStarred: function(articleId, subscriptionId, success) {
    this._editTag(
      articleId,
      subscriptionId,
      null,
      "user/-/state/com.google/starred",
      success
    )
  },

  _editTag: function(articleId, subscriptionId, addTag, removeTag, success) {
    Log.debug("editing tag for article id = " + articleId + " and subscription id = " + subscriptionId)

    this._getEditToken(function(token) {
      var parameters = {
        T: token,
        i: articleId,
        s: subscriptionId
      }

      if(addTag) parameters.a = addTag
      if(removeTag) parameters.r = removeTag

      new Ajax.Request(Api.BASE_URL + "edit-tag", {
        method: "post",
        parameters:  parameters,
        requestHeaders: this._requestHeaders(),
        onSuccess: success
      })
    }.bind(this))
  },

  _requestHeaders: function() {
    return {Authorization:"GoogleLogin auth=" + this.auth}
  },

  _getEditToken: function(success) {
    if(this.editToken) {
      Log.debug("using last edit token - " + this.editToken)
      success(this.editToken)
    }
    else {
      var parameters = {

      }

      new Ajax.Request(Api.BASE_URL + "token", {
        method: "get",
        parameters: parameters,
        requestHeaders: {Authorization:"GoogleLogin auth=" + this.auth},
        onSuccess: function(response) {
          this.editToken = response.responseText
          Log.debug("retrieved edit token - " + this.editToken)
          success(this.editToken)
        }.bind(this)

      })
    }
  }
})

Api.BASE_URL = "http://www.google.com/reader/api/0/"